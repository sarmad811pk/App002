@model SurveyApp.Models.Study
@using SurveyApp.Models;
@using System.Data;
@{
    ViewBag.Title = "Study Information Editor";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ds = SurveyApp.DataHelper.StudyGetByID(Model.Id > 0 ? Model.Id : 0);
}

<h2><a href="javascript:void(0);" id="back" onclick="history.go(-1);"></a> &nbsp;Study Information Editor</h2>

<style>
    ._panel { background: #fafafa; border: solid 1px #cccccc; padding: 10px; border-radius: 6px; }
    .form-control[disabled] {
        cursor: help;
    }
</style>
<br />
@functions{
    public DataSet ds = null;
    public bool checkSurveyExists(string type, int surveyId, int scheduleId = 0) {
        if (ds != null && ds.Tables[3].Rows.Count > 0)
        {
            foreach (DataRow dr in ds.Tables[3].Rows)
            {
                if (type == "survey")
                {
                    if ((int)dr["SurveyId"] == surveyId)
                    {
                        return true;
                    }
                }
                else if (type == "parentschedule")
                {
                    if ((int)dr["ScheduleIdParent"] == scheduleId && (int)dr["SurveyId"] == surveyId)
                    {
                        return true;
                    }
                }
                else if (type == "teacherschedule")
                {
                    if ((int)dr["ScheduleIdTeacher"] == scheduleId && (int)dr["SurveyId"] == surveyId)
                    {
                        return true;
                    }
                }
                
            }
        }       
        
        return false;
    }

}

@using (Html.BeginForm("StudyAddEdit", "Study", FormMethod.Post, new { style = "padding-left: 24px;" }))
{
    @Html.ValidationSummary();
    @Html.HiddenFor(s => s.Id, new { name = "hdnStudyId", value = Model.Id })
    <div class="form-group">
        <label class="control-label col-sm-2">Study:</label>
        <div class="col-sm-4">
            @Html.TextBoxFor(s => s.Name, new { id = "txtStudyName", @class = "form-control", placeholder = "Study Name" })            
        </div>        
        <label class="control-label col-sm-1">Status:</label>
        <div class="col-sm-2">
            @Html.DropDownListFor(s => s.Status, new SelectList(StudyStatus.GetAllStatus(), "StatusId", "StatusOption"), "Select status", new { id = "ddlStudies", @class = "form-control", })            
        </div>
        <div class="col-sm-2">@Html.ActionLink("Add Schedule Template", "Index", "Schedule", new object { }, new { @class = "btn btn-link" }) </div>
    </div>
    
    <div class="col-sm-12">
    <table class="table table-striped table-hover" id="tblStudy">
    <thead>
      <tr class="small">
        <th>Survey</th>
        <th>Schedule For Parent</th>
        <th>Schedule For Teacher</th>
      </tr>
    </thead>
    <tbody>

        @{int index = 0;}
        @foreach (System.Data.DataRow dr in ds.Tables[1].Rows)
        {
            <tr>
                <td>
                    <label class="col-sm-12">
                        <input type="checkbox" name="Survey@(index)" value="@dr["Id"]" @(checkSurveyExists("survey", (int)dr["Id"]) == true? "checked='checked'" : "") onclick="enableDisableSchedule(this);"/>&nbsp;
                        @dr["Title"].ToString()
                    </label>
                </td>

                <td>
                    <select class="form-control" name="Parent@(index)" disabled="disabled" title="Please select a Survey first to associate this Schedule">
                        <option value="0">---</option>
                        @foreach (System.Data.DataRow drSchedule in ds.Tables[2].Rows)
                        {
                        <option value="@drSchedule["Id"]" @(checkSurveyExists("parentschedule", (int)dr["Id"], (int)drSchedule["Id"]) == true ? "selected='selected'" : "")>@drSchedule["Title"]</option>
                        }
                    </select>
                </td>
                <td>
                    <select class="form-control" name="Teacher@(index)" disabled="disabled" title="Please select a Survey first to associate this Schedule">
                        <option value="0">---</option>
                        @foreach (System.Data.DataRow drSchedule in ds.Tables[2].Rows)
                        {
                            <option value="@drSchedule["Id"]" @(checkSurveyExists("teacherschedule", (int)dr["Id"], (int)drSchedule["Id"]) == true ? "selected='selected'" : "")>@drSchedule["Title"]</option>
                        }
                    </select>
                </td>

            </tr>
            index++;
        }
     </table>
    </div>
    <div class="form-group">
        <div class="col-sm-4">
            @Html.Hidden("SurveyCount", ds.Tables[1].Rows.Count)
            @Html.Hidden("StudyId", Model.Id)
            <button type="submit" class="btn btn-default">Save Information</button>
        </div>
    </div>
}

<script type="text/javascript">
    function enableDisableSchedule(elem) {
        var isChecked = $(elem)[0].checked;
        
        if (isChecked == true) {
            $(elem).closest("tr").find("select").removeAttr("disabled").removeAttr("title");
        }
        else {
            $(elem).closest("tr").find("select").val(0);
            $(elem).closest("tr").find("select").attr("disabled", "disabled").attr("title", "Please select a Survey first to associate this Schedule");
        }
    }

    $(function () {
        $("#tblStudy").find("input[type=checkbox]:checked").each(function (index, obj) {
            if ($(obj)[0].checked == true) {
                enableDisableSchedule($(obj));
            }
        });
    });
</script>