@using System.Data;
@using SurveyApp.Models;

@{
    ViewBag.Title = "eBit - Data Manager";
    Layout = "~/Views/Shared/_Layout.cshtml";


    int studyId = String.IsNullOrEmpty(Request.QueryString["studyId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["studyId"]);
    int userId = String.IsNullOrEmpty(Request.QueryString["userId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["userId"]);
    int childId = String.IsNullOrEmpty(Request.QueryString["childId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["childId"]);
    int surveyId = String.IsNullOrEmpty(Request.QueryString["surveyId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["surveyId"]);

    DataTable dtUsers, dtChildren, dtSurveys;

    using (var sContext = new StudyContext())
    {
        Study objStd = studyId == 0 ? sContext.Studies.OrderBy(s => s.Id).FirstOrDefault() : sContext.Studies.Where(s => s.Id == studyId).FirstOrDefault();
        studyId = objStd.Id;
    }

    DataSet dsDefaultDataValues = SurveyApp.DataHelper.getDefaultDataValues(studyId);
    dtUsers = dsDefaultDataValues.Tables[0];
    dtChildren = dsDefaultDataValues.Tables[1];
    dtSurveys = dsDefaultDataValues.Tables[2];

    if(userId <= 0 && dtUsers.Rows.Count > 0)
    {
        userId = Convert.ToInt32(dtUsers.Rows[0]["UserId"]);
    }

    if (childId <= 0 && dtChildren.Rows.Count > 0)
    {
        childId = Convert.ToInt32(dtChildren.Rows[0]["ChildId"]);
    }

    if (surveyId <= 0 && dtSurveys.Rows.Count > 0)
    {
        surveyId = Convert.ToInt32(dtSurveys.Rows[0]["SurveyId"]);
    }

    string childName = "";
    DataRow[] drs = dtChildren.Select("ChildId = " + childId);
    if(drs.Length > 0)
    {
        childName = drs[0]["Name"].ToString();
    }

    DataSet dsData = SurveyApp.DataHelper.getAllData(userId, childId, surveyId);
}

<script type="text/javascript">
    $(function () {
        $("#tblData").DataTable({ dom: 'Bfrtip', buttons: [{ extend: 'excel', text: "Export to Excel", title: '@(childName == "" ? "Child_Data" : childName + "_Data")' }], "oLanguage": { "sInfo": "Displaying _START_ to _END_ of _TOTAL_ Entries" } });
    });
</script>

<div>
    <h2 class="col-sm-11" style="margin: 0px;padding: 0px;">Data Manager</h2>
    <div style="clear:both;"></div>
</div>

<div class="controls" style="margin-bottom: 24px;margin-top: 24px;">
    <select id="ddlStudy" class="col-sm-9 form-control" style="margin-right: 5px;width: 250px;" onchange="getData(this, 1);">
        @foreach (Study std in Study.StudyGetAll())
        {
            <option value="@std.Id" @(std.Id == studyId ? "selected='selected'" : "")>@std.Name</option>
        }
    </select>

    <select id="ddlUsers" class="col-sm-9 form-control" style="margin-right: 5px;width: 250px;" onchange="getData(this, 2);">
        @foreach(DataRow dr in dtUsers.Rows)
        {
            <option value="@dr["UserId"]" @((int)dr["UserId"] == userId ? "selected='selected'" : "")>@dr["UserName"]</option>
        }
    </select>

    <select id="ddlChildren" class="col-sm-9 form-control" style="margin-right: 5px;width: 250px;" onchange="getData(this, 3);">
        @foreach (DataRow dr in dtChildren.Rows)
        {
            <option value="@dr["ChildId"]" @((int)dr["ChildId"] == childId ? "selected='selected'" : "")>@dr["Name"]</option>
        }
    </select>

    <select id="ddlSurveys" class="col-sm-9 form-control" style="width: 250px;" onchange="getData(this, 4);">
        @foreach (DataRow dr in dtSurveys.Rows)
        {
            <option value="@dr["SurveyId"]" @((int)dr["SurveyId"] == surveyId ? "selected='selected'" : "")>@dr["Title"]</option>
        }
    </select>

    <div style="clear:both;"></div>
</div>

<div>
    <table class="table table-striped table-hover" id="tblData">
        <thead>
            <tr>
                <th>Question</th>
                <th>Answer</th>
                <th>Score</th>
                <th>Entry Date</th>
                <th>Schedule Date</th>
            </tr>
        </thead>
        <tbody>
            @if (dsData != null && dsData.Tables.Count > 0 && dsData.Tables[0] != null && dsData.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow dr in dsData.Tables[0].Rows)
                {
                    <tr>
                        <td>@dr["Question"]</td>
                        <td>@dr["Answers"]</td>
                        <td>@dr["Score"]</td>
                        <td>@(dr["EntryDate"] != DBNull.Value ? Convert.ToDateTime(dr["EntryDate"]).ToString("MM/dd/yyyy") : "")</td>
                        <td>@(dr["ScheduleDate"] != DBNull.Value ? Convert.ToDateTime(dr["ScheduleDate"]).ToString("MM/dd/yyyy") : "")</td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<script type="text/javascript">
    function getData(elem, type) {
        var studyId, userId, childId, surveyId;
        studyId = $("#ddlStudy option:selected").val();
        userId = type != 1 ? ($("#ddlUsers option:selected").val() == undefined || $("#ddlUsers option:selected").val() == "undefined" ? 0 : $("#ddlUsers option:selected").val()) : 0;
        childId = type != 1 ? ($("#ddlChildren option:selected").val() == undefined || $("#ddlChildren option:selected").val() == "undefined" ? 0 : $("#ddlChildren option:selected").val()) : 0;
        surveyId = type != 1 ? ($("#ddlSurveys option:selected").val() == undefined || $("#ddlSurveys option:selected").val() == "undefined" ? 0 : $("#ddlSurveys option:selected").val()) : 0;

        location.href = "@Url.Action("Index", "Data")" + "?studyId=" + studyId + "&userId=" + userId +"&childId=" + childId + "&surveyId=" + surveyId;
    }
</script>