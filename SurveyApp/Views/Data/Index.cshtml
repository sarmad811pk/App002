@using System.Data;
@using SurveyApp.Models;

@{
    ViewBag.Title = "eBit - Data Manager";
    Layout = "~/Views/Shared/_Layout.cshtml";


    int studyId = String.IsNullOrEmpty(Request.QueryString["studyId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["studyId"]);
    int userId = String.IsNullOrEmpty(Request.QueryString["userId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["userId"]);
    int childId = String.IsNullOrEmpty(Request.QueryString["childId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["childId"]);
    int surveyId = String.IsNullOrEmpty(Request.QueryString["surveyId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["surveyId"]);

    DataTable dtUsers, dtChildren, dtSurveys;

    using (var sContext = new StudyContext())
    {
        Study objStd = studyId == 0 ? sContext.Studies.OrderBy(s => s.Id).FirstOrDefault() : sContext.Studies.Where(s => s.Id == studyId).FirstOrDefault();
        studyId = objStd.Id;
    }

    DataSet dsDefaultDataValues = SurveyApp.DataHelper.getDefaultDataValues(studyId);
    dtUsers = dsDefaultDataValues.Tables[0];
    dtChildren = dsDefaultDataValues.Tables[1];
    dtSurveys = dsDefaultDataValues.Tables[2];

    if(userId <= 0 && dtUsers.Rows.Count > 0)
    {
        userId = Convert.ToInt32(dtUsers.Rows[0]["UserId"]);
    }

    if (childId <= 0 && dtChildren.Rows.Count > 0)
    {
        childId = Convert.ToInt32(dtChildren.Rows[0]["ChildId"]);
    }

    if (surveyId <= 0 && dtSurveys.Rows.Count > 0)
    {
        surveyId = Convert.ToInt32(dtSurveys.Rows[0]["SurveyId"]);
    }

    string childName = "";
    DataRow[] drs = dtChildren.Select("ChildId = " + childId);
    if(drs.Length > 0)
    {
        childName = drs[0]["Name"].ToString();
    }

    DataSet dsData = SurveyApp.DataHelper.getAllData(userId, childId, surveyId);
}

<style type="text/css">
    a.excel{
        padding: 6px 10px 7px 10px;
        color: #fff;
        font-weight: normal;
        font-size: 14px;
        cursor: pointer;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        -o-border-radius: 4px;
        border-radius: 4px;
        display: inline-block;
        background-color: #333;
        background-size: auto 18px;
        border: 1px solid #ccc;
        margin: 0px;
        text-decoration: none;
        font-family: Arial;
        float: right;
        margin-right: 6px;
    }
    .controls select{
        text-transform:capitalize;
        margin-right: 5px;width: 250px;
    }
    .controls .titles span{
        margin-right: 5px;width: 250px;padding: 0px;
    }
</style>

<script type="text/javascript">
    $(function () {
        $("#tblData").DataTable({ dom: 'Bfrtip', buttons: [{ extend: 'excel', text: "Export to Excel", title: '@(childName == "" ? "Child_Data" : childName + "_Data")', exportOptions: { modifier: { search: 'none', order: 'original' } } }] });
        $("#tblSurveyList").DataTable({  searching: false, paging: true, lengthChange: false, info: false, "oLanguage": { "sInfo": "Displaying _START_ to _END_ of _TOTAL_ Questionnaires" } });
    });
</script>

<div>
    <h2 class="col-sm-11" style="margin: 0px;padding: 0px;">Data Manager</h2>
    <div style="clear:both;"></div>
</div>


<div class="controls" style="margin-bottom: 24px;margin-top: 24px;">
    <div class="titles">
        <span class="col-sm-9">Study</span>
        <span class="col-sm-9">Respondent</span>
        <span class="col-sm-9">Child</span>
        <span class="col-sm-9">Questionnaire</span>
    </div>
    <select id="ddlStudy" class="col-sm-9 form-control" onchange="getData(this, 1);">
        @foreach (Study std in Study.StudyGetAll())
        {
            <option value="@std.Id" @(std.Id == studyId ? "selected='selected'" : "")>@std.Name</option>
        }
    </select>

    <select id="ddlUsers" class="col-sm-9 form-control" onchange="getData(this, 2);">
        @foreach(DataRow dr in dtUsers.Rows)
        {
            <option value="@dr["UserId"]" @((int)dr["UserId"] == userId ? "selected='selected'" : "")>@dr["UserName"]</option>
        }
    </select>

    <select id="ddlChildren" class="col-sm-9 form-control" onchange="getData(this, 3);">
        @foreach (DataRow dr in dtChildren.Rows)
        {
            <option value="@dr["ChildId"]" @((int)dr["ChildId"] == childId ? "selected='selected'" : "")>@dr["Name"]</option>
        }
    </select>

    <select id="ddlSurveys" class="col-sm-9 form-control" onchange="getData(this, 4);">
        @foreach (DataRow dr in dtSurveys.Rows)
        {
            <option value="@dr["SurveyId"]" @((int)dr["SurveyId"] == surveyId ? "selected='selected'" : "")>@dr["Title"]</option>
        }
    </select>

    <div style="clear:both;"></div>
</div>

<div style="clear:both;"></div>
<div class="info" style="border:solid 1px #CCC;padding: 6px;background-color: #FFF;">
    <div>
        <h4>@childName<span><a href="javascript:void(0);" class="excel" onclick="$('.infoDetails .buttons-excel').click();"><i class="fa fa-file-excel-o">&nbsp;</i>Export to Excel</a></span></h4>
    </div>
    <table cellpadding="0" cellspacing="0" class="table table-striped table-hover" id="tblSurveyList">
        <thead>
            <tr>
                <td>Questionnaire</td>
                <td style="width: 120px;">Schedule Date</td>
                <td style="width: 130px;">Completion(%)</td>
            </tr>
        </thead>
        <tbody>
            @if (dsData != null && dsData.Tables.Count > 0 && dsData.Tables[0] != null && dsData.Tables[0].Rows.Count > 0)
            {
                foreach (DataRow dr in dsData.Tables[0].Rows)
                {
                    <tr>
                        <td>@dr["Title"]</td>
                        <td><a href='@Url.Action("Question", "UserQuestion")?surveyID=@dr["SurveyId"]&userId=@userId&ChildId=@dr["ChildID"]&ChildName=@childName&perioddate=@(dr["ScheduleDate"] != DBNull.Value ? Convert.ToDateTime(dr["ScheduleDate"]).ToString("MM/dd/yyyy") : "")' target="_blank" style="text-decoration: underline;color: #337ab7;">@(dr["ScheduleDate"] != DBNull.Value ? Convert.ToDateTime(dr["ScheduleDate"]).ToString("MM/dd/yyyy") : "")</a></td>
                        <td>@dr["Percentage"]</td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<div class="infoDetails" style="display:none;">
    <table class="table table-striped table-hover" id="tblData">
        <thead>
            <tr>
                <th>Question</th>
                <th>Answer</th>
                <th>Score</th>
                <th>Entry Date</th>
                <th>Schedule Date</th>
            </tr>
        </thead>
        <tbody>
            @if (dsData != null && dsData.Tables.Count > 0 && dsData.Tables[1] != null && dsData.Tables[1].Rows.Count > 0)
            {
                foreach (DataRow dr in dsData.Tables[1].Rows)
                {
                    <tr>
                        <td>@dr["Question"]</td>
                        <td>@dr["Answers"]</td>
                        <td>@dr["Score"]</td>
                        <td>@(dr["EntryDate"] != DBNull.Value ? Convert.ToDateTime(dr["EntryDate"]).ToString("MM/dd/yyyy") : "")</td>
                        <td>@(dr["ScheduleDate"] != DBNull.Value ? Convert.ToDateTime(dr["ScheduleDate"]).ToString("MM/dd/yyyy") : "")</td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<script type="text/javascript">
    function getData(elem, type) {
        var studyId, userId, childId, surveyId;
        studyId = $("#ddlStudy option:selected").val();
        userId = type != 1 ? ($("#ddlUsers option:selected").val() == undefined || $("#ddlUsers option:selected").val() == "undefined" ? 0 : $("#ddlUsers option:selected").val()) : 0;
        childId = type != 1 ? ($("#ddlChildren option:selected").val() == undefined || $("#ddlChildren option:selected").val() == "undefined" ? 0 : $("#ddlChildren option:selected").val()) : 0;
        surveyId = type != 1 ? ($("#ddlSurveys option:selected").val() == undefined || $("#ddlSurveys option:selected").val() == "undefined" ? 0 : $("#ddlSurveys option:selected").val()) : 0;

        location.href = "@Url.Action("Index", "Data")" + "?studyId=" + studyId + "&userId=" + userId +"&childId=" + childId + "&surveyId=" + surveyId;
    }
    
</script>