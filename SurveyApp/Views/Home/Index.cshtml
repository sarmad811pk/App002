@using SurveyApp.Models;
@using System.Data;

@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int studyId = Model == null ? 0 : (int)Model;
    string studyName = "";
    string divSelected = String.IsNullOrEmpty(Request.QueryString["div"]) == true ? "" : Request.QueryString["div"].ToString();

    using (StudyContext sContext = new StudyContext())
    {
        Study objStd = studyId == 0 ? sContext.Studies.OrderBy(s => s.Id).FirstOrDefault() : sContext.Studies.Where(s => s.Id == studyId).FirstOrDefault();
        studyId = objStd.Id;
        studyName = objStd.Name;
    }

    int childId = String.IsNullOrEmpty(Request.QueryString["childId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["childId"]);

    var userId = WebSecurity.CurrentUserId;
    System.Data.DataSet dschildren = SurveyApp.DataHelper.GetChildbyStudyID(studyId, 0);

}

<style type="text/css">
    .stats .separator{clear:both;margin-bottom: 10px;}
    .topControls #ddlStudy, .topControls #ddlChildren{float: right; width: 22%; background-color: #fff;}
    .tabs{margin-bottom: 12px;}
    .tabs .current, .comparison .previous {border-top: none;}
    .tabs ul {height: 41px;margin: 0px;list-style: none;padding:0px;border-bottom: solid 1px #CCC;}
    .tabs li {float: left;}
    .tabs li a {text-align:center;margin-right: 2px;border: 1px solid transparent;padding: 10px 15px;display: block;position: relative;text-shadow: none;text-decoration:none;color:#333;min-width: 141px;}
    .tabs li a:hover {border-color: #FEFEFE;cursor: pointer;}
    .tabs li a.selected {color: #4d6b8a;background-color: #fff;border: 1px solid #B1B1B1;border-bottom-color: transparent;cursor: default;}
    .tabs .tblComparison .trhdn{display:none !important;}
    .tabs .title{clear: both;background-color: #FFF;text-align: center;padding: 10px;border-right: solid 1px #CCC;border-left: solid 1px #CCC;}
    .tabs .linker{text-decoration:none;padding: 2px 4px;background-color: #333;color: #FFF;margin-top: 4px;display: inline-block;}
    
</style>


@section featured {
    @*<section class="featured">
        <div class="content-wrapper" style="position:relative;">
            <hgroup class="title">
                <h2>Admin Dashboad</h2>
            </hgroup>            
            <a href="@Url.Action("Clinician", "Home")" target="_blank" style="position:absolute;bottom: 10px;right: 4px; color: #FFF;">Clinician Dashboard</a>
        </div>
    </section>*@
}

<div class="stats">
    <div class="tabs">
        <ul class="tabdashboard">
            <li>
                <a class="selected" href="#0" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide();$('.childrendropdown').hide(); $('.dashboardDetails').show();">Dashboard</a>
            </li>
            <li>
                <a href="#1" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.childrendropdown').hide();$('.childrendropdown').show();$('.graphsDetails').show();">Graphs</a>
            </li>
            <li>
                <a href="#2" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.childrendropdown').hide();$('.Adverse').show();">Adverse Reactions & Life Events</a>
            </li>
            <li>
                <a href="#3" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.childrendropdown').hide();$('.WeeklyGraph').show();">Weekly Progress</a>
            </li>
        </ul>
    </div>
    <div class="topControls">
        <div style="display:inline-block;"><h3 style="margin: 7px 0px 0px 0px;text-transform: capitalize;">@studyName</h3></div>

        <select id="ddlChildren" class="col-sm-9 form-control childrendropdown" onchange="getChildInfo(this);">
            <option value="0">All Children</option>
            @foreach (DataRow drChild in dschildren.Tables[0].Rows)
            {
                <option value="@drChild["ChildId"]"  @(childId == (int)drChild["childId"] ? "selected=selected" : "")>@drChild["Name"]</option>
            }
        </select>

        <select id="ddlStudy" class="col-sm-9 form-control" style="margin-right: 5px;" onchange="getStudyInfo(this);">            
        @foreach (Study objStudy in Study.StudyGetAll())
        {
            <option value="@objStudy.Id"  @(studyId == objStudy.Id ? "selected=selected" : "")>@objStudy.Name</option>
        }
        </select>        
    </div>
    <div class="separator"></div>

    <div class="dashboardDetails __tabs">
        @{Html.RenderPartial("_ChildrenCounts", studyId);}


        <div class="separator"></div>
        @{Html.RenderPartial("_SurveyCompletion", studyId);}

        <div class="separator"></div>
        @{Html.RenderPartial("_DetailComparison", studyId);}
    </div>
    <div class="Adverse __tabs" style="display:none;"> 
        @{Html.RenderPartial("_AdverseEvent", studyId);}


    </div>
    <div class="graphsDetails __tabs" style="/*display:none;*/">
        <div class="separator"></div>
        @{Html.RenderPartial("_Charts", new ViewDataDictionary { { "studyId" , studyId }, { "childIdts", childId } });}
    </div>
    <div class="WeeklyGraph __tabs">
        @{Html.RenderPartial("_WeeklyChart", studyId);}
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $(".graphsDetails").hide();
        $(".Adverse").hide();
        $(".WeeklyGraph").hide();
        $(".childrendropdown").hide();

        var hash;
        if (window.location.hash) {
            hash = window.location.hash.substring(1);
        }
        var selectedDiv = "@divSelected";

        $(".tabdashboard").find("li:eq("+ (selectedDiv != "" ? selectedDiv : hash) +")").find("a").click();
    });

    function getVisibleDiv(){
        if ($(".dashboardDetails").is(":visible") == true) { return 0; }
        if ($(".graphsDetails").is(":visible") == true) { return 1; }
        if ($(".Adverse").is(":visible") == true) { return 2; }
        if ($(".WeeklyGraph").is(":visible") == true) { return 3; }
    }

    function getStudyInfo(elem) {
        var div = getVisibleDiv();
        var studyId = $(elem).val();
        location.href = "@Url.Action("Index", "Home")" + "?studyId=" + (studyId == 0 ? "" : studyId) + "&childId=" + @childId + "&div=" + div;
    }
    function getChildInfo(elem) {
        var div = getVisibleDiv();
        var childId = $(elem).val();
        location.href = "@Url.Action("Index", "Home")" + "?studyId=" + @studyId +"&childId=" + (childId == 0 ? "" : childId) + "&div=" + div;
    }
</script>