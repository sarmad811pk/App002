@using SurveyApp.Models;
@using System.Data;
@{
    ViewBag.Title = "Survey Manager";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string studyName = "";
    //var ds = SurveyApp.DataHelper.SurveyGetAll();


    string divSelected = String.IsNullOrEmpty(Request.QueryString["div"]) == true ? "" : Request.QueryString["div"].ToString();
    int childIdts = String.IsNullOrEmpty(Request.QueryString["childIdts"]) == true ? 0 : Convert.ToInt32(Request.QueryString["childIdts"]);
    int studyId = String.IsNullOrEmpty(Request.QueryString["studyId"]) == true ? 0 : Convert.ToInt32(Request.QueryString["studyId"]);

    using (StudyContext sContext = new StudyContext())
    {
        Study objStd = studyId == 0 ? sContext.Studies.OrderBy(s => s.Id).FirstOrDefault() : sContext.Studies.Where(s => s.Id == studyId).FirstOrDefault();
        studyId = objStd.Id;
        studyName = objStd.Name;
    }
    System.Data.DataSet dschildren = SurveyApp.DataHelper.GetChildbyStudyID(studyId, WebSecurity.CurrentUserId);

    if(String.IsNullOrEmpty(Request.QueryString["childIdts"]) == true)
    {
        if(dschildren != null && dschildren.Tables.Count > 0 && dschildren.Tables[0].Rows.Count > 0)
        {
            childIdts = (int)dschildren.Tables[0].Rows[0]["ChildId"];
        }
    }
}

    @section featured {
        <section class="featured">
            <div class="content-wrapper">
                <hgroup class="title">

                    <h2>Welcome <b>@User.Identity.Name</b></h2>

                </hgroup>
            </div>
        </section>
    }

    <style type="text/css">
        .separator {
            clear: both;
            margin-bottom: 10px;
        }
        .featured .content-wrapper{
            width: 100%;
        }
        .featured .content-wrapper h2{
            background-image: -webkit-linear-gradient(top, #00aaff 0%, #b9def0 100%);
            background-image: -o-linear-gradient(top, #00aaff 0%, #4b9dc5 100%);
            background-image: -webkit-gradient(linear, left top, left bottom, from(#00aaff), to(#4b9dc5));
            background-image: linear-gradient(to bottom, #00aaff 0%, #4b9dc5 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffd9edf7', endColorstr='#ffb9def0', GradientType=0);
            background-repeat: repeat-x;
            border-color: #000000;
        }
    </style>
    <style type="text/css">
        .topControls #ddlStudy, .topControls #ddlChildren{float: right; width: 22%; background-color: #fff;}
        .tabs{margin-bottom: 12px;}
        .tabs .current, .comparison .previous {border-top: none;}
        .tabs ul {height: 41px;margin: 0px;list-style: none;padding:0px;border-bottom: solid 1px #CCC;}
        .tabs li {float: left;}
        .tabs li a {text-align:center;margin-right: 2px;border: 1px solid transparent;padding: 10px 15px;display: block;position: relative;text-shadow: none;text-decoration:none;color:#333;min-width: 141px;}
        .tabs li a:hover {border-color: #FEFEFE;cursor: pointer;}
        .tabs li a.selected {color: #4d6b8a;background-color: #fff;border: 1px solid #B1B1B1;border-bottom-color: transparent;cursor: default;}
        .tabs .tblComparison .trhdn{display:none !important;}
        .tabs .title{clear: both;background-color: #FFF;text-align: center;padding: 10px;border-right: solid 1px #CCC;border-left: solid 1px #CCC;}
        .tabs .linker{text-decoration:none;padding: 2px 4px;background-color: #333;color: #FFF;margin-top: 4px;display: inline-block;}
    </style>

    <div class="waiting" style="@((Request.Url.ToString().ToLower().Contains("/home/") == true && Request.Url.ToString().ToLower().Contains("/home/about") == false && Request.Url.ToString().ToLower().Contains("/home/contact") == false) || (Request.Url.ToString().ToLower().Contains("/userquestion/") == true && Request.Url.ToString().ToLower().Contains("/userquestion/question") == false && Request.Url.ToString().ToLower().Contains("/userquestion/index?childid=") == false) ? "" : "display:none;")"><div>Please Wait...</div></div> 
    <div class="tabs toptabs" style="display:none;">
        <ul class="tabdashboard">
            <li>
                <a class="selected" href="#0" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.dashboard-controls').hide(); $('.dashboardDetails').show();">Dashboard</a>
            </li>
            <li>
                <a href="#1" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.childrendropdown').hide(); $('.quesDetails').show(); $('.dashboard-controls').show();">Assessment</a>
            </li>
            <li>
                <a href="#2" onclick="$('.tabdashboard a').removeClass('selected'); $(this).addClass('selected'); $('.__tabs').hide(); $('.childrendropdown').hide(); $('.childrendropdown').show(); $('.graphsDetails').show(); $('.dashboard-controls').show();">Visualization</a>
            </li>            
        </ul>
    </div>

    <div style="height: 38px;display:none;" class="col-md-12 topControls">
        <table>
            <tr>
                <td>
                    <select id="ddlStudy" class="col-sm-9 form-control" onchange="getStudyInfo(this);" style="font-weight: bold; color: #00ADEE;border:solid 2px #00adee;width:250px;">
                        @foreach (DataRow drStd in dschildren.Tables[1].Rows)
                        {
                            <option value="@drStd["Id"]" @(studyId == (int)drStd["Id"] ? "selected=selected" : "")>@drStd["Name"]</option>
                        }
                    </select>
                </td>
                <td>
                    <span style="font-size: 24px;" class="dashboard-controls">&nbsp;&nbsp; &rArr; &nbsp;&nbsp;</span>
                </td>
                <td>
                    <select id="ddlChildren" class="col-sm-9 form-control dashboard-controls" onchange="getChildInfo(this);" style="font-weight: bold; color: #00ADEE;border:solid 2px #00adee;width:250px;">
                        <option value="0">All Chlidren</option>
                        @foreach (System.Data.DataRow drch in dschildren.Tables[0].Rows)
                        {
                            <option value="@drch["ID"]" @(childIdts == (int)drch["ID"] ? "selected=selected" : "")>@drch["Name"]</option>
                        }
                    </select>
                </td>
            </tr>
        </table>
    </div>


    <div class="dashboardDetails __tabs" style="opacity:0;">
        <div class="separator"></div>
        <div class="col-sm-12">
            @{Html.RenderPartial("~/Views/Home/_SurveyCompletion.cshtml", new ViewDataDictionary { { "studyId", studyId }, { "studyName", studyName } });}
        </div>
        <div class="separator"></div>
        <div class="col-sm-12">
            @{Html.RenderPartial("~/Views/Home/_AdverseEvent.cshtml", new ViewDataDictionary { { "studyId", studyId }, { "studyName", studyName } });}
        </div>
    </div>
    <div class="graphsDetails __tabs" style="opacity:0;">
        <div class="separator"></div>
        <div class="col-sm-12">
            @{Html.RenderPartial("~/Views/Home/_Charts.cshtml", new ViewDataDictionary { { "studyId", studyId }, { "studyName", studyName }, { "childIdts", childIdts } });}
        </div>
    </div>
    <div class="quesDetails __tabs" style="opacity:0;">
        <div class="col-sm-12">
            @{Html.RenderPartial("_ChildDetails", new ViewDataDictionary { { "studyId", studyId }, { "studyName", studyName }, { "childIdts", childIdts } });}
        </div>        
    </div>

    <script type="text/javascript">
        $(window).load(function () {
            $(".waiting").hide();
            $(".toptabs").show();
            $(".topControls").show();

            var hash = 0;
            if (window.location.hash) {
                hash = window.location.hash.substring(1);
            }
            
            $(".tabdashboard").find("li:eq(" + (hash > 2 ? 2 : hash) + ")").find("a").click();
            if (hash > 2) {
                $(".graphTabs .graphSections").find("li:eq(" + (hash - 3) + ")").find("a").click();
            }
            $(".__tabs").css("opacity", "1");
        });

        function getVisibleDiv() {
            if ($(".dashboardDetails").is(":visible") == true) { return 0; }
            if ($(".quesDetails").is(":visible") == true) { return 1; }
            if ($(".graphsDetails").is(":visible") == true) { return getInnerVisibleDiv(); }
        }

        function getInnerVisibleDiv() {
            if ($(".gDetails .parentdiv").is(":visible") == true) { return 3; }
            if ($(".gDetails .teacherdiv").is(":visible") == true) { return 4; }
            if ($(".gDetails .parentteacherdiv").is(":visible") == true) { return 5; }
            if ($(".gDetails .weeklydiv").is(":visible") == true) { return 6; }
            if ($(".gDetails .lifeeventsdiv").is(":visible") == true) { return 7; }
        }

        function getChildInfo(elem) {
            var div = getVisibleDiv();
            var childIdts = $(elem).val();
            location.href = "@Url.Action("Index", "UserQuestion")" + "?studyId=" + @studyId +"&childIdts=" + childIdts + "#" + div;
        }

        function getStudyInfo(elem) {
            var div = getVisibleDiv();
            var studyId = $(elem).val();
            location.href = "@Url.Action("Index", "UserQuestion")" + "?studyId=" + (studyId == 0 ? "" : studyId) + "#" + div;
        }
    </script>
    
